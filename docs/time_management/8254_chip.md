# 8254 芯片

## 定时器和计数器概述

**定时器** 定时控制在计算机系统中非常重要。硬件定时器由数字电路中的计数电路构成。通过记录高精度晶振脉冲信号的个数，输出准确的时间间隔。

**计数器** 如果外设提供具有一定随机性的脉冲信号，计数器则主要反映脉冲的个数。

定时的实现一般有以下三种方法：
+ **软件延时** 利用 CPU 每执行一条指令都需要固定的指令周期原理，通过执行一个延时程序段实现
+ **不可编程的硬件定时** 采用分频器、单稳电路或简易定时电路控制定时时间
+ **可编程的硬件定时** 软硬件结合，用可编程定时芯片构成一个方便灵活的定时电路

## 8254 定时计数器

+ 8254 是 8253 的改进版，由 intel 出品。
+ 拥有 3 个独立的 16 位计数器通道。
+ 每个计数器有 6 种工作方式，按二进制或十进制计数。
+ 每个计数器在开始工作前必须预置时间常数，每个计数器在工作过程中的当前计数值可被 CPU 读出。时间常数也可在计数过程中更改。
+ 不同工作方式的区分点：
  + 输出波形
  + 计数过程中门控信号的影响
  + 启动触发方式

但每种工作方式的设定与启动流程是类似的：
  1. 设定工作方式
  2. 设定计数初值
  3. 硬件启动
  4. 计数器不断减一
  5. 计数结束


## 8254 芯片工作方式 3 ： 方波发生器

在工作方式 3 的情境下，8254 芯片的输出引脚输出方波（计数初值为偶数）或近似方波（计数初值为奇数）。具有自动重装计数初值的功能，因此一旦开始计数就会在输出端输出连续不断的方波。

## HelenOS 中的 8254 驱动程序

8245 驱动程序声明在 ```arch/amd64/include/drivers/i8254.h```，定义在```arch/amd64/src/drivers/i8254.c```，主要包含
+ ```void i8254_init(void)``` 8254 初始化
+ ```void i8254_normal_operation(void)``` 8254 初始化
+ ```void i8254_calibrate_delay_loop(void)``` 利用 8254 校准延迟函数
+ ```void i8254_interrupt(int n, istate_t *istate)``` 8254 中断处理

### 8245 芯片初始化与中断注册

#### 宏定义

```clike
#define CLK_PORT1	0x40      /* 计数器 0 计数初值置位端口 */
#define CLK_PORT4	0x43      /* 8254 模式控制寄存器读写端口 */
#define CLK_CONST	1193180   /* 8254 的时钟输入频率 */
```
#### 初始化

```clike
void i8254_init(void)
{
	i8254_normal_operation();
}

void i8254_normal_operation(void)
{
	outb(CLK_PORT4, 0x36);  /* 模式设置 */
	pic_disable_irqs(1<<IRQ_CLK);  /* 关闭 PIC 上时钟中断的产生 */
	outb(CLK_PORT1, (CLK_CONST/HZ) & 0xf);  /* 计数器 0 低 8 位写入 */
	outb(CLK_PORT1, (CLK_CONST/HZ) >> 8);   /* 计数器 0 高 8 位写入 */
	pic_enable_irqs(1<<IRQ_CLK);   /* 使能 PIC 上时钟中断 */
	exc_register(VECTOR_CLK, "i8254_clock", (iroutine) i8254_interrupt); /* 时钟中断注册 */
}
```
函数```i8254_normal_operation```第一行```outb(CLK_PORT4, 0x36)```把```0x36```即```0b00110110```写入 8254 模式控制寄存器读写端口，高两位```00```表示使用计数器 0； 接下来两位```11```表示计数值读写方式为先读写低 8 位，后读写高 8 位；接下来三位```011```表示计数器工作方式为方式 3，即方波产生器。最低位的```0```表示采用二进制计数。

随后，PIC 中断控制器上的时钟中断被关闭，计数初值被写入计数器 ```0``` ，```HZ``` 是时钟中断产生的频率，它的值被宏定义为 ```100```。因此计数器产生的方波的频率约为 ```100 Hz```。随后 PIC 时钟中断重新开启。

初始化的最后一步是注册 8254 的中断处理程序，这个函数的功能请参考[中断](/exception_and_interrupt/interrupt.md)模块的分析。


### 8254 用于校准 CPU 延迟循环并测量 CPU 频率

函数 ```i8254_calibrate_delay_loop``` 利用时钟频率为```1193180```的 8254 计数器测算出了每毫秒时间内```asm_fake_loop```(该函数的作用和实现参考 [delay](/time_management/delay.md) 模块) 循环几次，并把计算结果保存到 ```CPU->delay_loop_const```。

函数 ```i8254_calibrate_delay_loop``` 还利用```rdtsc```指令读出 CPU 的运行周期数，从而计算出 CPU 的以```mhz```为单位的频率，并保存在```CPU->frequency_mhz```中。

具体的实现比较繁琐，在此不列出，请参考源码。


### 8254 的中断处理程序

前面我们提到 8254 的初始化程序注册了 8254 的中断处理程序。那么该中断处理程序做了那些事情呢？代码如下

```clike
void i8254_interrupt(int n, istate_t *istate)
{
	trap_virtual_eoi();
	clock();
}
```

该中断处理程序做了两件事。首先是调用```trap_virtual_eoi()```发送```end_of_interrupt```即中断以及被处理的信号，```trap_virtual_eoi()```具体做的事情与架构有关，在 ```amd64```架构下，就是给 8259 PIC 控制器发送 EOI 信号，具体参考 [8259芯片](/undefined.md) 模块。第二件事是调用 ```clock``` 函数处理时钟中断，```clock``` 函数的功能分析具体参考 [clock](/time_management/clock.md) 模块。
